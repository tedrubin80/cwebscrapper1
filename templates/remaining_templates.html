<!-- templates/all_releases.html -->
{% extends "base.html" %}

{% block title %}All Releases - Criterion Collection Tracker{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 fw-bold">
            <i class="fas fa-list me-2"></i>All Releases
        </h1>
        <div class="text-muted">
            {{ pagination.total }} films found
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filter & Search
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="status" class="form-label">Release Status</label>
                    <select name="status" id="status" class="form-select">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Releases</option>
                        <option value="released" {% if status_filter == 'released' %}selected{% endif %}>Released</option>
                        <option value="upcoming" {% if status_filter == 'upcoming' %}selected{% endif %}>Coming Soon</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="search" class="form-label">Search</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Search titles, directors, or spine numbers..." value="{{ search }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="per_page" class="form-label">Results Per Page</label>
                    <select name="per_page" id="per_page" class="form-select">
                        <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
                        <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>Apply Filters
                    </button>
                    <a href="{{ url_for('all_releases') }}" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-times me-1"></i>Clear All
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Results -->
    {% if films %}
    <div class="row g-4 mb-5">
        {% for film in films %}
        <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="card film-card h-100 shadow-sm">
                <div class="position-relative">
                    {% if film.cover_art_url %}
                    <img src="{{ film.cover_art_url }}" class="cover-img card-img-top" alt="{{ film.title }}" loading="lazy">
                    {% else %}
                    <div class="cover-img card-img-top bg-light d-flex align-items-center justify-content-center">
                        <i class="fas fa-film fa-3x text-muted"></i>
                    </div>
                    {% endif %}
                    <span class="badge bg-{{ 'success' if film.release_status == 'released' else 'info' }} status-badge">
                        {{ 'Released' if film.release_status == 'released' else 'Coming Soon' }}
                    </span>
                    {% if film.spine_number %}
                    <span class="badge bg-dark position-absolute top-0 start-0 m-2">
                        #{{ film.spine_number }}
                    </span>
                    {% endif %}
                </div>
                <div class="card-body d-flex flex-column">
                    <h6 class="card-title fw-bold mb-2">{{ film.title }}</h6>
                    <p class="text-muted small mb-2">
                        <i class="fas fa-user-circle me-1"></i>{{ film.director or 'Unknown Director' }}
                    </p>
                    <p class="text-muted small mb-2">
                        <i class="fas fa-calendar me-1"></i>{{ film.release_date|date }}
                    </p>
                    {% if film.format %}
                    <p class="small mb-3">
                        <span class="badge bg-secondary">{{ film.format }}</span>
                    </p>
                    {% endif %}
                    <div class="mt-auto d-flex gap-2">
                        <a href="{{ url_for('film_detail', film_id=film.id) }}" class="btn btn-sm btn-primary flex-grow-1">
                            <i class="fas fa-info-circle me-1"></i>Details
                        </a>
                        {% if film.url %}
                        <a href="{{ film.url }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="View on Criterion.com">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <nav aria-label="Page navigation" class="d-flex justify-content-center">
        <ul class="pagination">
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('all_releases', page=pagination.prev_num, status=status_filter, search=search, per_page=pagination.per_page) }}">
                    <i class="fas fa-chevron-left me-1"></i>Previous
                </a>
            </li>
            {% endif %}
            
            {% for page_num in range(1, pagination.total_pages + 1) %}
                {% if page_num <= 3 or page_num > pagination.total_pages - 3 or (page_num >= pagination.page - 2 and page_num <= pagination.page + 2) %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('all_releases', page=page_num, status=status_filter, search=search, per_page=pagination.per_page) }}">
                        {{ page_num }}
                    </a>
                </li>
                {% elif page_num == pagination.page - 3 or page_num == pagination.page + 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('all_releases', page=pagination.next_num, status=status_filter, search=search, per_page=pagination.per_page) }}">
                    Next<i class="fas fa-chevron-right ms-1"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-search fa-4x text-muted mb-3"></i>
        <h4 class="text-muted">No Films Found</h4>
        <p class="text-muted mb-4">Try adjusting your search criteria or run a scrape to update the database.</p>
        <div class="d-flex justify-content-center gap-3">
            <a href="{{ url_for('all_releases') }}" class="btn btn-outline-primary">
                <i class="fas fa-times me-1"></i>Clear Filters
            </a>
            {% if not scraping_status.in_progress %}
            <form action="{{ url_for('trigger_scrape') }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync me-1"></i>Update Database
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

<!-- templates/film_detail.html -->
{% extends "base.html" %}

{% block title %}{{ film.title }} - Criterion Collection Tracker{% endblock %}

{% block content %}
<div class="container my-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('all_releases') }}">All Releases</a></li>
            <li class="breadcrumb-item active">{{ film.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                {% if film.cover_art_url %}
                <img src="{{ film.cover_art_url }}" class="card-img-top" alt="{{ film.title }}" style="height: 500px; object-fit: cover;">
                {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 500px;">
                    <i class="fas fa-film fa-5x text-muted"></i>
                </div>
                {% endif %}
                <div class="card-body text-center">
                    {% if film.spine_number %}
                    <h5 class="card-title mb-2">
                        <span class="badge bg-dark fs-6">Spine #{{ film.spine_number }}</span>
                    </h5>
                    {% endif %}
                    <span class="badge bg-{{ 'success' if film.release_status == 'released' else 'info' }} fs-6 mb-2">
                        {{ 'Released' if film.release_status == 'released' else 'Coming Soon' }}
                    </span>
                    {% if film.format %}
                    <div class="mt-2">
                        <span class="badge bg-secondary">{{ film.format }}</span>
                    </div>
                    {% endif %}
                    {% if film.url %}
                    <div class="mt-3">
                        <a href="{{ film.url }}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt me-1"></i>View on Criterion.com
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="mb-4">
                <h1 class="display-5 fw-bold mb-3">{{ film.title }}</h1>
                
                <div class="row mb-4">
                    <div class="col-sm-6">
                        <h6 class="text-muted mb-1">Director</h6>
                        <p class="h5">{{ film.director or 'Unknown' }}</p>
                    </div>
                    <div class="col-sm-6">
                        <h6 class="text-muted mb-1">Release Date</h6>
                        <p class="h5">{{ film.release_date|date }}</p>
                    </div>
                </div>

                {% if film.description %}
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Description</h6>
                    <p class="lead">{{ film.description }}</p>
                </div>
                {% endif %}

                {% if film.special_features %}
                <div class="mb-4">
                    <h6 class="text-muted mb-2">Special Features</h6>
                    <p>{{ film.special_features }}</p>
                </div>
                {% endif %}

                <div class="mb-4">
                    <h6 class="text-muted mb-3">Technical Details</h6>
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                {% if film.spine_number %}
                                <tr>
                                    <td class="fw-bold" style="width: 30%;">Spine Number:</td>
                                    <td>#{{ film.spine_number }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td class="fw-bold">Status:</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if film.release_status == 'released' else 'info' }}">
                                            {{ 'Released' if film.release_status == 'released' else 'Coming Soon' }}
                                        </span>
                                    </td>
                                </tr>
                                {% if film.format %}
                                <tr>
                                    <td class="fw-bold">Format:</td>
                                    <td>{{ film.format }}</td>
                                </tr>
                                {% endif %}
                                {% if film.price %}
                                <tr>
                                    <td class="fw-bold">Price:</td>
                                    <td>{{ film.price }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td class="fw-bold">Last Updated:</td>
                                    <td>{{ film.updated_at|datetime }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Added to Database:</td>
                                    <td>{{ film.created_at|datetime }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2">
                    {% if film.url %}
                    <a href="{{ film.url }}" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt me-1"></i>View on Criterion.com
                    </a>
                    {% endif %}
                    <a href="{{ url_for('all_releases') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to All Releases
                    </a>
                    <a href="{{ url_for('all_releases', search=film.director) }}" class="btn btn-outline-info">
                        <i class="fas fa-user me-1"></i>More by {{ film.director or 'this director' }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- templates/status.html -->
{% extends "base.html" %}

{% block title %}System Status - Criterion Collection Tracker{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="h2 fw-bold mb-4">
                <i class="fas fa-cog me-2"></i>System Status
            </h1>

            <!-- Current Status Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Current Status
                    </h5>
                </div>
                <div class="card-body">
                    {% if status.in_progress %}
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="fas fa-spinner fa-spin fa-2x me-3"></i>
                        <div>
                            <h5 class="alert-heading">Scraping in Progress</h5>
                            <p class="mb-0">Please wait while we fetch the latest releases from Criterion Collection. This may take a few minutes.</p>
                        </div>
                    </div>
                    {% elif status.error_message %}
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <h5 class="alert-heading">Last Scrape Failed</h5>
                            <p class="mb-0">{{ status.error_message }}</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <h5 class="alert-heading">System Ready</h5>
                            <p class="mb-0">No scraping currently in progress. Database is ready for queries.</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="table-responsive mt-4">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 30%;">Last Run:</td>
                                    <td>{{ status.last_run|datetime if status.last_run else 'Never' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Last Success:</td>
                                    <td>{{ status.last_success|datetime if status.last_success else 'Never' }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Total Films:</td>
                                    <td>{{ status.total_films }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Current Status:</td>
                                    <td>
                                        {% if status.in_progress %}
                                        <span class="badge bg-warning">Scraping</span>
                                        {% elif status.error_message %}
                                        <span class="badge bg-danger">Error</span>
                                        {% else %}
                                        <span class="badge bg-success">Ready</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-play me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Manually trigger a scraping session to update the database with the latest releases from Criterion Collection.</p>
                    
                    <div class="d-flex flex-wrap gap-2">
                        {% if status.in_progress %}
                        <button type="button" class="btn btn-secondary" disabled>
                            <i class="fas fa-spinner fa-spin me-1"></i>Scraping in Progress...
                        </button>
                        {% else %}
                        <form action="{{ url_for('trigger_scrape') }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-primary" onclick="return confirm('Start scraping now? This may take a few minutes.')">
                                <i class="fas fa-sync me-1"></i>Start Scraping
                            </button>
                        </form>
                        {% endif %}

                        <a href="{{ url_for('export_data') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-download me-1"></i>Export Data
                        </a>
                        
                        <a href="{{ url_for('all_releases') }}" class="btn btn-outline-info">
                            <i class="fas fa-list me-1"></i>View All Films
                        </a>
                    </div>
                </div>
            </div>

            <!-- API Information Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-code me-2"></i>API Endpoints
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Use these REST API endpoints to integrate with external applications:</p>
                    
                    <div class="table-responsive mb-3">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Method</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>/api/films</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Get films with optional filters</td>
                                </tr>
                                <tr>
                                    <td><code>/api/stats</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Get database statistics</td>
                                </tr>
                                <tr>
                                    <td><code>/api/scrape</code></td>
                                    <td><span class="badge bg-warning">POST</span></td>
                                    <td>Trigger scraping programmatically</td>
                                </tr>
                                <tr>
                                    <td><code>/export</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Download complete dataset as JSON</td>
                                </tr>
                                <tr>
                                    <td><code>/health</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Health check endpoint</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h6 class="fw-bold">Example API Usage:</h6>
                    <pre class="bg-light p-3 rounded small"><code># Get recent releases
curl {{ request.host_url }}api/films?status=released&limit=10

# Get upcoming releases  
curl {{ request.host_url }}api/films?status=upcoming

# Search for films by director
curl "{{ request.host_url }}api/films?search=kurosawa"

# Trigger scraping
curl -X POST {{ request.host_url }}api/scrape

# Get system stats
curl {{ request.host_url }}api/stats</code></pre>
                </div>
            </div>

            <!-- System Information -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-server me-2"></i>System Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="fw-bold" style="width: 30%;">Database:</td>
                                    <td>SQLite (criterion_releases.db)</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Source:</td>
                                    <td><a href="https://criterion.com" target="_blank" class="text-decoration-none">criterion.com</a></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Rate Limiting:</td>
                                    <td>2 seconds between requests</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Robots.txt Compliance:</td>
                                    <td><span class="badge bg-success">Yes</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Auto-Scraping:</td>
                                    <td><span class="badge bg-info">Every 24 hours</span></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Deployment:</td>
                                    <td>DigitalOcean App Platform</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if status.in_progress %}
<script>
// Auto-refresh page every 15 seconds when scraping is in progress
setTimeout(function() {
    location.reload();
}, 15000);
</script>
{% endif %}
{% endblock %}
